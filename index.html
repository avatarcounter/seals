<!-- 1. Load Service Worker -->
<script src="coi-serviceworker.js"></script>

<script>
    // 2. Helper to ensure FFmpeg is actually loaded before running
    function checkFFmpeg() {
        return new Promise((resolve) => {
            const interval = setInterval(() => {
                if (window.FFmpeg) {
                    clearInterval(interval);
                    resolve();
                }
            }, 100);
        });
    }

    // 3. Insert the library script dynamically
    const script = document.createElement('script');
    script.src = "https://unpkg.com";
    document.head.appendChild(script);

    let ffmpegInstance = null;

    async function processVideo() {
        const status = document.getElementById('status');
        const btn = document.getElementById('renderBtn');
        btn.disabled = true;

        try {
            status.innerText = "Checking Library...";
            await checkFFmpeg(); // Wait until FFmpeg is defined

            if (!ffmpegInstance) {
                status.innerText = "Loading FFmpeg Engine...";
                ffmpegInstance = FFmpeg.createFFmpeg({ 
                    log: true,
                    corePath: 'https://unpkg.com'
                });
                await ffmpegInstance.load();
            }

            const ffmpeg = ffmpegInstance;
            // ... (rest of your logic from previous response)
            status.innerText = "Processing...";
            
        } catch (e) {
            status.innerText = "Error: " + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }
</script>
